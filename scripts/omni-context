#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

usage() {
  cat <<'EOF'
OmniContext CLI

Usage:
  omni-context [--lang zh-CN|en|ja] <command> [args...]

Commands:
  init         Initialize a workspace .omnicontext tree
  sync         Refresh workspace mappings and top-level index
  status       Report OmniContext health and coverage
  new-project  Register a project and create core project records
  new-doc      Create a project document and append it to an index

Examples:
  omni-context --lang zh-CN init /path/to/workspace
  omni-context init /path/to/workspace
  omni-context status /path/to/workspace
  omni-context sync /path/to/workspace
  omni-context new-project /path/to/workspace my-app apps/my-app
  omni-context new-doc /path/to/workspace my-app technical "Query Cache Notes"
EOF
}

if [[ "${#}" -lt 1 ]]; then
  usage >&2
  exit 1
fi

if [[ "${1:-}" == "--lang" ]]; then
  if [[ "${#}" -lt 3 ]]; then
    usage >&2
    exit 1
  fi
  export OMNI_CONTEXT_LANGUAGE="${2}"
  shift 2
fi

command_name="${1}"
shift

case "${command_name}" in
  init)
    exec "${SCRIPT_DIR}/init-workspace.sh" "$@"
    ;;
  sync)
    exec "${SCRIPT_DIR}/sync-workspace.sh" "$@"
    ;;
  status)
    exec "${SCRIPT_DIR}/status-workspace.sh" "$@"
    ;;
  new-project)
    exec "${SCRIPT_DIR}/new-project.sh" "$@"
    ;;
  new-doc)
    exec "${SCRIPT_DIR}/new-doc.sh" "$@"
    ;;
  help|-h|--help)
    usage
    ;;
  *)
    echo "Unknown command: ${command_name}" >&2
    echo >&2
    usage >&2
    exit 1
    ;;
esac
